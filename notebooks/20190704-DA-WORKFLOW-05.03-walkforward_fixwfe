{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "%matplotlib inline\n",
    "%load_ext autoreload\n",
    "%autoreload 2\n",
    "\n",
    "import datetime\n",
    "import os.path\n",
    "import backtrader as bt\n",
    "import numpy as np\n",
    "from pprint import pformat\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import datetime"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Strategy"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create a Stratey\n",
    "class TestStrategy(bt.Strategy):\n",
    "    params = (\n",
    "        ('maperiod', 15),\n",
    "        ('printlog', False),\n",
    "    )\n",
    "\n",
    "    def log(self, txt, dt=None, doprint=False):\n",
    "        ''' Logging function fot this strategy'''\n",
    "        if self.params.printlog or doprint:\n",
    "            dt = dt or self.datas[0].datetime.date(0)\n",
    "            print('%s, %s' % (dt.isoformat(), txt))\n",
    "\n",
    "    def __init__(self):\n",
    "        # Keep a reference to the \"close\" line in the data[0] dataseries\n",
    "        self.dataclose = self.datas[0].close\n",
    "\n",
    "        # To keep track of pending orders and buy price/commission\n",
    "        self.order = None\n",
    "        self.buyprice = None\n",
    "        self.buycomm = None\n",
    "\n",
    "        # Add a MovingAverageSimple indicator\n",
    "        self.sma = bt.indicators.SimpleMovingAverage(\n",
    "            self.datas[0], period=self.params.maperiod)\n",
    "\n",
    "    def notify_order(self, order):\n",
    "        if order.status in [order.Submitted, order.Accepted]:\n",
    "            # Buy/Sell order submitted/accepted to/by broker - Nothing to do\n",
    "            return\n",
    "\n",
    "        # Check if an order has been completed\n",
    "        # Attention: broker could reject order if not enough cash\n",
    "        if order.status in [order.Completed]:\n",
    "            if order.isbuy():\n",
    "                self.log(\n",
    "                    'BUY EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' %\n",
    "                    (order.executed.price,\n",
    "                     order.executed.value,\n",
    "                     order.executed.comm))\n",
    "\n",
    "                self.buyprice = order.executed.price\n",
    "                self.buycomm = order.executed.comm\n",
    "            else:  # Sell\n",
    "                self.log('SELL EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' %\n",
    "                         (order.executed.price,\n",
    "                          order.executed.value,\n",
    "                          order.executed.comm))\n",
    "\n",
    "            self.bar_executed = len(self)\n",
    "\n",
    "        elif order.status in [order.Canceled, order.Margin, order.Rejected]:\n",
    "            self.log('Order Canceled/Margin/Rejected')\n",
    "\n",
    "        # Write down: no pending order\n",
    "        self.order = None\n",
    "\n",
    "    def notify_trade(self, trade):\n",
    "        if not trade.isclosed:\n",
    "            return\n",
    "\n",
    "        self.log('OPERATION PROFIT, GROSS %.2f, NET %.2f' %\n",
    "                 (trade.pnl, trade.pnlcomm))\n",
    "\n",
    "    def next(self):\n",
    "        # Simply log the closing price of the series from the reference\n",
    "        self.log('Close, %.2f' % self.dataclose[0])\n",
    "\n",
    "        # Check if an order is pending ... if yes, we cannot send a 2nd one\n",
    "        if self.order:\n",
    "            return\n",
    "\n",
    "        # Check if we are in the market\n",
    "        if not self.position:\n",
    "\n",
    "            # Not yet ... we MIGHT BUY if ...\n",
    "            if self.dataclose[0] > self.sma[0]:\n",
    "\n",
    "                # BUY, BUY, BUY!!! (with all possible default parameters)\n",
    "                self.log('BUY CREATE, %.2f' % self.dataclose[0])\n",
    "\n",
    "                # Keep track of the created order to avoid a 2nd order\n",
    "                self.order = self.buy()\n",
    "\n",
    "        else:\n",
    "\n",
    "            if self.dataclose[0] < self.sma[0]:\n",
    "                # SELL, SELL, SELL!!! (with all possible default parameters)\n",
    "                self.log('SELL CREATE, %.2f' % self.dataclose[0])\n",
    "\n",
    "                # Keep track of the created order to avoid a 2nd order\n",
    "                self.order = self.sell()\n",
    "\n",
    "    def stop(self):\n",
    "        self.log('maperiod:%2d, %.2f' %\n",
    "                 (self.params.maperiod, self.broker.getvalue()), doprint=True)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Analyzers"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [],
   "source": [
    "class DecisiveAnalyzer(bt.Analyzer):\n",
    "    \n",
    "    def __init__(self):\n",
    "        self.maperiod = self.strategy.params.maperiod\n",
    "        self.equity = []\n",
    "\n",
    "    def start(self):\n",
    "        # Not needed ... but could be used\n",
    "        self.init_cash = self.strategy.broker.cash \n",
    "        self.ntrade = 0\n",
    "\n",
    "    def next(self):\n",
    "        # Not needed ... but could be used\n",
    "        pass\n",
    "\n",
    "    def notify_trade(self, trade):\n",
    "\n",
    "        if trade.isclosed:\n",
    "            self.equity.append({'dt': self.strategy.datetime.datetime(), \n",
    "                                'equity': self.strategy.broker.getvalue()})\n",
    "            self.ntrade += 1\n",
    "            \n",
    "    def stop(self):\n",
    "        self.final_cash = self.strategy.broker.cash\n",
    "        self.final_val = self.strategy.broker.get_value()\n",
    "\n",
    "    def get_analysis(self):\n",
    "        equity = np.asarray([self.init_cash,] + self.equity)\n",
    "\n",
    "        outp = {\n",
    "            'params': (self.maperiod),\n",
    "            'profit': self.final_val - self.init_cash,\n",
    "            'ntrade': self.ntrade,\n",
    "#             'trades': np.diff(equity).tolist(),\n",
    "            'equity': self.equity,\n",
    "        }\n",
    "        \n",
    "        return outp\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "def best_result_from_cerebro_opti_run(result):\n",
    "    params  = []\n",
    "    n_trades = []\n",
    "    profit   = []\n",
    "    trades   = []\n",
    "    for res in result:\n",
    "        r = res[0].analyzers.decisive.get_analysis()\n",
    "        params.append(r['params'])\n",
    "        n_trades.append(r['ntrade'])\n",
    "        profit.append(r['profit'])\n",
    "        trades.append(r['trades'])\n",
    "\n",
    "    prof_ind = np.argmax(profit) \n",
    "    best_params = params[prof_ind]\n",
    "    best_profit = profit[prof_ind]\n",
    "    best_ntrades = n_trades[prof_ind]\n",
    "    best_trades = trades[prof_ind]\n",
    "    \n",
    "    print('best:{} profit:{} trades:{}'.format(best_params, best_profit, best_ntrades))\n",
    "    return (best_params, best_profit, best_ntrades, best_trades)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<matplotlib.axes._subplots.AxesSubplot at 0x11a7367b8>"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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\n",
      "text/plain": [
       "<Figure size 432x288 with 1 Axes>"
      ]
     },
     "metadata": {
      "needs_background": "light"
     },
     "output_type": "display_data"
    }
   ],
   "source": [
    "fname_symbol = 'CL'\n",
    "folder_name = '5min'\n",
    "suffix = '5min_20160103_20190405'\n",
    "\n",
    "df = pd.read_parquet(os.path.join('../data/processed/{}/'.format(folder_name), '{}_{}.parquet'.format(fname_symbol, suffix)))\n",
    "df = (df.resample('4h', label='left', base=18).agg({'Open': 'first', 'High': 'max', 'Low': 'min', 'Close': 'last', 'Volume': 'sum'}))\n",
    "df.columns = [col_name.lower() for col_name in df.columns]\n",
    "df = df.dropna()\n",
    "df['2017-01-01':'2017-04-01']['close'].plot()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## In-sample Parameters"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "periods = [\n",
    "{'run': 0, 'oos': ('2017-04-01', '2017-05-01'), 'is': ('2017-01-01', '2017-04-01')},\n",
    "{'run': 1, 'oos': ('2017-05-01', '2017-06-01'), 'is': ('2017-02-01', '2017-05-01')},\n",
    "{'run': 2, 'oos': ('2017-06-01', '2017-07-01'), 'is': ('2017-03-01', '2017-06-01')},\n",
    "{'run': 3, 'oos': ('2017-07-01', '2017-08-01'), 'is': ('2017-04-01', '2017-07-01')},\n",
    "{'run': 4, 'oos': ('2017-08-01', '2017-09-01'), 'is': ('2017-05-01', '2017-08-01')},\n",
    "{'run': 5, 'oos': ('2017-09-01', '2017-10-01'), 'is': ('2017-06-01', '2017-09-01')},\n",
    "{'run': 6, 'oos': ('2017-10-01', '2017-11-01'), 'is': ('2017-07-01', '2017-10-01')},\n",
    "{'run': 7, 'oos': ('2017-11-01', '2017-12-01'), 'is': ('2017-08-01', '2017-11-01')},\n",
    "{'run': 8, 'oos': ('2017-12-01', '2018-01-01'), 'is': ('2017-09-01', '2017-12-01')},\n",
    "{'run': 9, 'oos': ('2018-01-01', '2018-02-01'), 'is': ('2017-10-01', '2018-01-01')},\n",
    "{'run': 10, 'oos': ('2018-02-01', '2018-03-01'), 'is': ('2017-11-01', '2018-02-01')},\n",
    "{'run': 11, 'oos': ('2018-03-01', '2018-04-01'), 'is': ('2017-12-01', '2018-03-01')},\n",
    "{'run': 12, 'oos': ('2018-04-01', '2018-05-01'), 'is': ('2018-01-01', '2018-04-01')},\n",
    "{'run': 13, 'oos': ('2018-05-01', '2018-06-01'), 'is': ('2018-02-01', '2018-05-01')},\n",
    "\n",
    "]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Start/End: 2017-01-01 - 2018-05-01\n",
      "2018-05-01, maperiod:10, 105030.00\n",
      "2018-05-01, maperiod:15, 110860.00\n",
      "2018-05-01, maperiod:20, 106930.00\n",
      "2018-05-01, maperiod:25, 108470.00\n",
      "2018-05-01, maperiod:30, 110390.00\n",
      "{'params': 10, 'profit': 5030.0, 'ntrade': 160, 'equity': [{'dt': datetime.datetime(2017, 1, 8, 18, 0), 'equity': 100500.0}, {'dt': datetime.datetime(2017, 1, 13, 6, 0), 'equity': 100350.0}, {'dt': datetime.datetime(2017, 1, 13, 14, 0), 'equity': 99910.0}, {'dt': datetime.datetime(2017, 1, 17, 2, 0), 'equity': 99660.0}, {'dt': datetime.datetime(2017, 1, 17, 18, 0), 'equity': 98310.0}, {'dt': datetime.datetime(2017, 1, 18, 2, 0), 'equity': 98280.0}, {'dt': datetime.datetime(2017, 1, 23, 6, 0), 'equity': 98040.0}, {'dt': datetime.datetime(2017, 1, 23, 18, 0), 'equity': 97980.0}, {'dt': datetime.datetime(2017, 1, 25, 6, 0), 'equity': 97570.0}, {'dt': datetime.datetime(2017, 1, 25, 18, 0), 'equity': 97540.0}, {'dt': datetime.datetime(2017, 1, 26, 6, 0), 'equity': 97210.0}, {'dt': datetime.datetime(2017, 1, 27, 6, 0), 'equity': 96750.0}, {'dt': datetime.datetime(2017, 1, 30, 10, 0), 'equity': 96140.0}, {'dt': datetime.datetime(2017, 1, 31, 22, 0), 'equity': 95590.0}, {'dt': datetime.datetime(2017, 2, 3, 10, 0), 'equity': 96500.0}, {'dt': datetime.datetime(2017, 2, 6, 10, 0), 'equity': 96410.0}, {'dt': datetime.datetime(2017, 2, 13, 10, 0), 'equity': 97190.0}, {'dt': datetime.datetime(2017, 2, 14, 18, 0), 'equity': 96860.0}, {'dt': datetime.datetime(2017, 2, 15, 18, 0), 'equity': 96720.0}, {'dt': datetime.datetime(2017, 2, 17, 6, 0), 'equity': 96720.0}, {'dt': datetime.datetime(2017, 2, 22, 6, 0), 'equity': 96830.0}, {'dt': datetime.datetime(2017, 2, 24, 6, 0), 'equity': 96640.0}, {'dt': datetime.datetime(2017, 2, 27, 14, 0), 'equity': 96510.0}, {'dt': datetime.datetime(2017, 3, 1, 2, 0), 'equity': 96370.0}, {'dt': datetime.datetime(2017, 3, 1, 14, 0), 'equity': 96110.0}, {'dt': datetime.datetime(2017, 3, 7, 2, 0), 'equity': 96020.0}, {'dt': datetime.datetime(2017, 3, 7, 14, 0), 'equity': 95850.0}, {'dt': datetime.datetime(2017, 3, 14, 10, 0), 'equity': 94820.0}, {'dt': datetime.datetime(2017, 3, 16, 10, 0), 'equity': 94830.0}, {'dt': datetime.datetime(2017, 3, 16, 18, 0), 'equity': 94750.0}, {'dt': datetime.datetime(2017, 3, 17, 2, 0), 'equity': 94700.0}, {'dt': datetime.datetime(2017, 3, 17, 14, 0), 'equity': 94440.0}, {'dt': datetime.datetime(2017, 3, 21, 10, 0), 'equity': 94250.0}, {'dt': datetime.datetime(2017, 3, 23, 10, 0), 'equity': 93560.0}, {'dt': datetime.datetime(2017, 3, 26, 22, 0), 'equity': 93290.0}, {'dt': datetime.datetime(2017, 4, 3, 14, 0), 'equity': 95730.0}, {'dt': datetime.datetime(2017, 4, 5, 18, 0), 'equity': 95920.0}, {'dt': datetime.datetime(2017, 4, 12, 14, 0), 'equity': 97500.0}, {'dt': datetime.datetime(2017, 4, 17, 14, 0), 'equity': 97150.0}, {'dt': datetime.datetime(2017, 4, 19, 14, 0), 'equity': 95440.0}, {'dt': datetime.datetime(2017, 4, 26, 10, 0), 'equity': 95250.0}, {'dt': datetime.datetime(2017, 4, 26, 18, 0), 'equity': 94690.0}, {'dt': datetime.datetime(2017, 4, 27, 2, 0), 'equity': 94670.0}, {'dt': datetime.datetime(2017, 4, 30, 18, 0), 'equity': 94520.0}, {'dt': datetime.datetime(2017, 5, 1, 2, 0), 'equity': 94530.0}, {'dt': datetime.datetime(2017, 5, 2, 10, 0), 'equity': 94240.0}, {'dt': datetime.datetime(2017, 5, 9, 2, 0), 'equity': 94380.0}, {'dt': datetime.datetime(2017, 5, 12, 6, 0), 'equity': 95770.0}, {'dt': datetime.datetime(2017, 5, 12, 14, 0), 'equity': 95620.0}, {'dt': datetime.datetime(2017, 5, 16, 14, 0), 'equity': 96540.0}, {'dt': datetime.datetime(2017, 5, 18, 6, 0), 'equity': 95880.0}, {'dt': datetime.datetime(2017, 5, 23, 2, 0), 'equity': 97650.0}, {'dt': datetime.datetime(2017, 5, 24, 14, 0), 'equity': 97760.0}, {'dt': datetime.datetime(2017, 5, 25, 6, 0), 'equity': 96830.0}, {'dt': datetime.datetime(2017, 5, 30, 6, 0), 'equity': 96440.0}, {'dt': datetime.datetime(2017, 6, 1, 18, 0), 'equity': 95550.0}, {'dt': datetime.datetime(2017, 6, 5, 6, 0), 'equity': 95110.0}, {'dt': datetime.datetime(2017, 6, 7, 14, 0), 'equity': 93130.0}, {'dt': datetime.datetime(2017, 6, 9, 10, 0), 'equity': 93060.0}, {'dt': datetime.datetime(2017, 6, 12, 18, 0), 'equity': 93150.0}, {'dt': datetime.datetime(2017, 6, 13, 10, 0), 'equity': 92800.0}, {'dt': datetime.datetime(2017, 6, 13, 18, 0), 'equity': 92450.0}, {'dt': datetime.datetime(2017, 6, 18, 22, 0), 'equity': 92330.0}, {'dt': datetime.datetime(2017, 6, 19, 14, 0), 'equity': 92190.0}, {'dt': datetime.datetime(2017, 6, 23, 10, 0), 'equity': 92000.0}, {'dt': datetime.datetime(2017, 7, 5, 6, 0), 'equity': 95330.0}, {'dt': datetime.datetime(2017, 7, 11, 6, 0), 'equity': 94930.0}, {'dt': datetime.datetime(2017, 7, 12, 22, 0), 'equity': 95940.0}, {'dt': datetime.datetime(2017, 7, 17, 14, 0), 'equity': 96230.0}, {'dt': datetime.datetime(2017, 7, 18, 14, 0), 'equity': 95840.0}, {'dt': datetime.datetime(2017, 7, 20, 14, 0), 'equity': 96400.0}, {'dt': datetime.datetime(2017, 7, 31, 10, 0), 'equity': 99330.0}, {'dt': datetime.datetime(2017, 8, 1, 10, 0), 'equity': 99250.0}, {'dt': datetime.datetime(2017, 8, 3, 14, 0), 'equity': 99120.0}, {'dt': datetime.datetime(2017, 8, 7, 6, 0), 'equity': 98610.0}, {'dt': datetime.datetime(2017, 8, 8, 2, 0), 'equity': 98660.0}, {'dt': datetime.datetime(2017, 8, 8, 10, 0), 'equity': 98050.0}, {'dt': datetime.datetime(2017, 8, 10, 14, 0), 'equity': 97430.0}, {'dt': datetime.datetime(2017, 8, 14, 14, 0), 'equity': 96530.0}, {'dt': datetime.datetime(2017, 8, 16, 14, 0), 'equity': 95630.0}, {'dt': datetime.datetime(2017, 8, 18, 10, 0), 'equity': 95460.0}, {'dt': datetime.datetime(2017, 8, 21, 14, 0), 'equity': 94260.0}, {'dt': datetime.datetime(2017, 8, 22, 14, 0), 'equity': 93910.0}, {'dt': datetime.datetime(2017, 8, 24, 10, 0), 'equity': 93360.0}, {'dt': datetime.datetime(2017, 8, 27, 22, 0), 'equity': 93170.0}, {'dt': datetime.datetime(2017, 9, 7, 10, 0), 'equity': 95500.0}, {'dt': datetime.datetime(2017, 9, 8, 6, 0), 'equity': 95350.0}, {'dt': datetime.datetime(2017, 9, 18, 6, 0), 'equity': 97010.0}, {'dt': datetime.datetime(2017, 9, 19, 14, 0), 'equity': 96110.0}, {'dt': datetime.datetime(2017, 9, 21, 6, 0), 'equity': 96130.0}, {'dt': datetime.datetime(2017, 9, 21, 22, 0), 'equity': 96150.0}, {'dt': datetime.datetime(2017, 9, 22, 6, 0), 'equity': 96000.0}, {'dt': datetime.datetime(2017, 9, 25, 2, 0), 'equity': 95820.0}, {'dt': datetime.datetime(2017, 9, 27, 6, 0), 'equity': 96210.0}, {'dt': datetime.datetime(2017, 9, 27, 14, 0), 'equity': 96010.0}, {'dt': datetime.datetime(2017, 9, 28, 14, 0), 'equity': 95450.0}, {'dt': datetime.datetime(2017, 10, 2, 6, 0), 'equity': 95230.0}, {'dt': datetime.datetime(2017, 10, 6, 10, 0), 'equity': 94550.0}, {'dt': datetime.datetime(2017, 10, 9, 18, 0), 'equity': 94420.0}, {'dt': datetime.datetime(2017, 10, 11, 22, 0), 'equity': 95750.0}, {'dt': datetime.datetime(2017, 10, 17, 2, 0), 'equity': 96640.0}, {'dt': datetime.datetime(2017, 10, 17, 14, 0), 'equity': 96220.0}, {'dt': datetime.datetime(2017, 10, 19, 2, 0), 'equity': 96280.0}, {'dt': datetime.datetime(2017, 10, 24, 6, 0), 'equity': 96560.0}, {'dt': datetime.datetime(2017, 10, 25, 14, 0), 'equity': 96330.0}, {'dt': datetime.datetime(2017, 10, 31, 10, 0), 'equity': 97740.0}, {'dt': datetime.datetime(2017, 11, 1, 14, 0), 'equity': 97240.0}, {'dt': datetime.datetime(2017, 11, 7, 18, 0), 'equity': 99470.0}, {'dt': datetime.datetime(2017, 11, 10, 14, 0), 'equity': 99430.0}, {'dt': datetime.datetime(2017, 11, 16, 10, 0), 'equity': 99060.0}, {'dt': datetime.datetime(2017, 11, 20, 10, 0), 'equity': 99790.0}, {'dt': datetime.datetime(2017, 11, 27, 6, 0), 'equity': 101730.0}, {'dt': datetime.datetime(2017, 11, 29, 14, 0), 'equity': 100870.0}, {'dt': datetime.datetime(2017, 11, 30, 14, 0), 'equity': 100160.0}, {'dt': datetime.datetime(2017, 12, 4, 6, 0), 'equity': 100440.0}, {'dt': datetime.datetime(2017, 12, 5, 18, 0), 'equity': 100210.0}, {'dt': datetime.datetime(2017, 12, 12, 10, 0), 'equity': 101290.0}, {'dt': datetime.datetime(2017, 12, 18, 14, 0), 'equity': 101080.0}, {'dt': datetime.datetime(2017, 12, 19, 10, 0), 'equity': 101080.0}, {'dt': datetime.datetime(2017, 12, 21, 10, 0), 'equity': 101190.0}, {'dt': datetime.datetime(2017, 12, 28, 10, 0), 'equity': 102510.0}, {'dt': datetime.datetime(2018, 1, 2, 14, 0), 'equity': 103070.0}, {'dt': datetime.datetime(2018, 1, 5, 2, 0), 'equity': 104530.0}, {'dt': datetime.datetime(2018, 1, 8, 10, 0), 'equity': 104260.0}, {'dt': datetime.datetime(2018, 1, 11, 18, 0), 'equity': 106170.0}, {'dt': datetime.datetime(2018, 1, 16, 6, 0), 'equity': 106050.0}, {'dt': datetime.datetime(2018, 1, 18, 10, 0), 'equity': 105910.0}, {'dt': datetime.datetime(2018, 1, 18, 18, 0), 'equity': 105690.0}, {'dt': datetime.datetime(2018, 1, 22, 2, 0), 'equity': 105550.0}, {'dt': datetime.datetime(2018, 1, 25, 18, 0), 'equity': 107420.0}, {'dt': datetime.datetime(2018, 1, 29, 10, 0), 'equity': 107140.0}, {'dt': datetime.datetime(2018, 2, 2, 10, 0), 'equity': 107360.0}, {'dt': datetime.datetime(2018, 2, 4, 18, 0), 'equity': 106840.0}, {'dt': datetime.datetime(2018, 2, 6, 14, 0), 'equity': 106220.0}, {'dt': datetime.datetime(2018, 2, 7, 6, 0), 'equity': 105350.0}, {'dt': datetime.datetime(2018, 2, 7, 14, 0), 'equity': 102930.0}, {'dt': datetime.datetime(2018, 2, 12, 14, 0), 'equity': 102190.0}, {'dt': datetime.datetime(2018, 2, 20, 6, 0), 'equity': 104060.0}, {'dt': datetime.datetime(2018, 2, 26, 10, 0), 'equity': 105400.0}, {'dt': datetime.datetime(2018, 2, 27, 10, 0), 'equity': 105140.0}, {'dt': datetime.datetime(2018, 2, 28, 14, 0), 'equity': 104250.0}, {'dt': datetime.datetime(2018, 3, 6, 18, 0), 'equity': 105130.0}, {'dt': datetime.datetime(2018, 3, 12, 14, 0), 'equity': 105180.0}, {'dt': datetime.datetime(2018, 3, 13, 14, 0), 'equity': 103780.0}, {'dt': datetime.datetime(2018, 3, 16, 10, 0), 'equity': 103880.0}, {'dt': datetime.datetime(2018, 3, 22, 10, 0), 'equity': 106040.0}, {'dt': datetime.datetime(2018, 3, 23, 6, 0), 'equity': 105590.0}, {'dt': datetime.datetime(2018, 3, 27, 10, 0), 'equity': 105930.0}, {'dt': datetime.datetime(2018, 4, 2, 10, 0), 'equity': 104880.0}, {'dt': datetime.datetime(2018, 4, 4, 6, 0), 'equity': 103630.0}, {'dt': datetime.datetime(2018, 4, 5, 22, 0), 'equity': 103610.0}, {'dt': datetime.datetime(2018, 4, 6, 14, 0), 'equity': 101890.0}, {'dt': datetime.datetime(2018, 4, 15, 22, 0), 'equity': 105710.0}, {'dt': datetime.datetime(2018, 4, 19, 18, 0), 'equity': 107240.0}, {'dt': datetime.datetime(2018, 4, 23, 6, 0), 'equity': 106850.00000000001}, {'dt': datetime.datetime(2018, 4, 24, 14, 0), 'equity': 106280.00000000001}, {'dt': datetime.datetime(2018, 4, 26, 14, 0), 'equity': 106240.00000000001}, {'dt': datetime.datetime(2018, 4, 26, 22, 0), 'equity': 105970.00000000001}, {'dt': datetime.datetime(2018, 4, 29, 18, 0), 'equity': 105950.0}, {'dt': datetime.datetime(2018, 5, 1, 6, 0), 'equity': 105030.0}]}\n",
      "{'params': 15, 'profit': 10859.999999999985, 'ntrade': 122, 'equity': [{'dt': datetime.datetime(2017, 1, 9, 6, 0), 'equity': 99810.0}, {'dt': datetime.datetime(2017, 1, 13, 14, 0), 'equity': 99700.0}, {'dt': datetime.datetime(2017, 1, 17, 18, 0), 'equity': 98350.0}, {'dt': datetime.datetime(2017, 1, 18, 6, 0), 'equity': 97440.0}, {'dt': datetime.datetime(2017, 1, 23, 6, 0), 'equity': 97200.0}, {'dt': datetime.datetime(2017, 1, 24, 18, 0), 'equity': 97230.0}, {'dt': datetime.datetime(2017, 1, 25, 6, 0), 'equity': 96760.0}, {'dt': datetime.datetime(2017, 1, 26, 6, 0), 'equity': 96660.0}, {'dt': datetime.datetime(2017, 1, 27, 10, 0), 'equity': 95960.0}, {'dt': datetime.datetime(2017, 1, 30, 10, 0), 'equity': 95350.0}, {'dt': datetime.datetime(2017, 1, 31, 18, 0), 'equity': 94890.0}, {'dt': datetime.datetime(2017, 2, 6, 10, 0), 'equity': 95660.0}, {'dt': datetime.datetime(2017, 2, 13, 10, 0), 'equity': 96220.0}, {'dt': datetime.datetime(2017, 2, 14, 14, 0), 'equity': 95990.0}, {'dt': datetime.datetime(2017, 2, 15, 18, 0), 'equity': 95850.0}, {'dt': datetime.datetime(2017, 2, 17, 6, 0), 'equity': 95750.0}, {'dt': datetime.datetime(2017, 2, 22, 6, 0), 'equity': 95860.0}, {'dt': datetime.datetime(2017, 2, 24, 6, 0), 'equity': 95670.0}, {'dt': datetime.datetime(2017, 2, 27, 14, 0), 'equity': 95540.0}, {'dt': datetime.datetime(2017, 3, 1, 2, 0), 'equity': 95400.0}, {'dt': datetime.datetime(2017, 3, 1, 14, 0), 'equity': 95140.0}, {'dt': datetime.datetime(2017, 3, 7, 18, 0), 'equity': 94870.0}, {'dt': datetime.datetime(2017, 3, 17, 14, 0), 'equity': 94900.0}, {'dt': datetime.datetime(2017, 3, 21, 10, 0), 'equity': 94540.0}, {'dt': datetime.datetime(2017, 3, 23, 10, 0), 'equity': 93810.0}, {'dt': datetime.datetime(2017, 3, 24, 10, 0), 'equity': 93680.0}, {'dt': datetime.datetime(2017, 3, 26, 22, 0), 'equity': 93410.0}, {'dt': datetime.datetime(2017, 4, 3, 18, 0), 'equity': 95760.0}, {'dt': datetime.datetime(2017, 4, 6, 2, 0), 'equity': 95970.0}, {'dt': datetime.datetime(2017, 4, 12, 18, 0), 'equity': 97620.0}, {'dt': datetime.datetime(2017, 4, 13, 14, 0), 'equity': 97390.0}, {'dt': datetime.datetime(2017, 4, 26, 10, 0), 'equity': 97040.0}, {'dt': datetime.datetime(2017, 4, 26, 18, 0), 'equity': 96480.0}, {'dt': datetime.datetime(2017, 4, 27, 2, 0), 'equity': 96460.0}, {'dt': datetime.datetime(2017, 4, 28, 6, 0), 'equity': 96390.0}, {'dt': datetime.datetime(2017, 4, 28, 14, 0), 'equity': 96180.0}, {'dt': datetime.datetime(2017, 5, 1, 6, 0), 'equity': 96080.0}, {'dt': datetime.datetime(2017, 5, 8, 6, 0), 'equity': 95540.0}, {'dt': datetime.datetime(2017, 5, 9, 10, 0), 'equity': 95040.0}, {'dt': datetime.datetime(2017, 5, 16, 18, 0), 'equity': 96690.0}, {'dt': datetime.datetime(2017, 5, 18, 6, 0), 'equity': 96030.0}, {'dt': datetime.datetime(2017, 5, 23, 6, 0), 'equity': 97070.0}, {'dt': datetime.datetime(2017, 5, 25, 6, 0), 'equity': 96840.0}, {'dt': datetime.datetime(2017, 5, 30, 10, 0), 'equity': 96310.0}, {'dt': datetime.datetime(2017, 5, 30, 22, 0), 'equity': 96200.0}, {'dt': datetime.datetime(2017, 6, 5, 6, 0), 'equity': 95760.0}, {'dt': datetime.datetime(2017, 6, 7, 14, 0), 'equity': 93780.0}, {'dt': datetime.datetime(2017, 6, 13, 10, 0), 'equity': 93620.0}, {'dt': datetime.datetime(2017, 6, 13, 18, 0), 'equity': 93270.0}, {'dt': datetime.datetime(2017, 6, 19, 14, 0), 'equity': 93130.0}, {'dt': datetime.datetime(2017, 6, 23, 6, 0), 'equity': 93000.0}, {'dt': datetime.datetime(2017, 7, 5, 6, 0), 'equity': 96330.0}, {'dt': datetime.datetime(2017, 7, 11, 6, 0), 'equity': 95860.0}, {'dt': datetime.datetime(2017, 7, 13, 6, 0), 'equity': 95940.0}, {'dt': datetime.datetime(2017, 7, 17, 14, 0), 'equity': 96230.0}, {'dt': datetime.datetime(2017, 7, 18, 14, 0), 'equity': 95840.0}, {'dt': datetime.datetime(2017, 7, 20, 18, 0), 'equity': 96040.0}, {'dt': datetime.datetime(2017, 7, 21, 10, 0), 'equity': 95430.0}, {'dt': datetime.datetime(2017, 8, 1, 10, 0), 'equity': 98510.0}, {'dt': datetime.datetime(2017, 8, 2, 22, 0), 'equity': 98360.0}, {'dt': datetime.datetime(2017, 8, 3, 14, 0), 'equity': 97860.0}, {'dt': datetime.datetime(2017, 8, 7, 6, 0), 'equity': 97350.0}, {'dt': datetime.datetime(2017, 8, 8, 10, 0), 'equity': 97140.0}, {'dt': datetime.datetime(2017, 8, 10, 14, 0), 'equity': 96520.0}, {'dt': datetime.datetime(2017, 8, 14, 14, 0), 'equity': 95400.0}, {'dt': datetime.datetime(2017, 8, 18, 10, 0), 'equity': 95090.0}, {'dt': datetime.datetime(2017, 8, 21, 14, 0), 'equity': 93890.0}, {'dt': datetime.datetime(2017, 8, 22, 14, 0), 'equity': 93540.0}, {'dt': datetime.datetime(2017, 8, 24, 10, 0), 'equity': 92990.0}, {'dt': datetime.datetime(2017, 9, 8, 6, 0), 'equity': 95300.0}, {'dt': datetime.datetime(2017, 9, 18, 18, 0), 'equity': 96980.0}, {'dt': datetime.datetime(2017, 9, 19, 14, 0), 'equity': 96080.0}, {'dt': datetime.datetime(2017, 9, 21, 10, 0), 'equity': 95870.0}, {'dt': datetime.datetime(2017, 9, 22, 6, 0), 'equity': 95810.0}, {'dt': datetime.datetime(2017, 9, 24, 22, 0), 'equity': 95700.0}, {'dt': datetime.datetime(2017, 9, 27, 14, 0), 'equity': 97000.0}, {'dt': datetime.datetime(2017, 9, 27, 22, 0), 'equity': 96930.0}, {'dt': datetime.datetime(2017, 9, 28, 14, 0), 'equity': 96380.0}, {'dt': datetime.datetime(2017, 10, 6, 10, 0), 'equity': 95390.0}, {'dt': datetime.datetime(2017, 10, 12, 10, 0), 'equity': 95720.0}, {'dt': datetime.datetime(2017, 10, 17, 14, 0), 'equity': 96450.0}, {'dt': datetime.datetime(2017, 10, 19, 6, 0), 'equity': 95860.0}, {'dt': datetime.datetime(2017, 10, 25, 14, 0), 'equity': 95840.0}, {'dt': datetime.datetime(2017, 10, 26, 10, 0), 'equity': 95710.0}, {'dt': datetime.datetime(2017, 11, 1, 14, 0), 'equity': 97170.0}, {'dt': datetime.datetime(2017, 11, 8, 10, 0), 'equity': 99280.0}, {'dt': datetime.datetime(2017, 11, 8, 18, 0), 'equity': 99090.0}, {'dt': datetime.datetime(2017, 11, 10, 14, 0), 'equity': 98740.0}, {'dt': datetime.datetime(2017, 11, 27, 10, 0), 'equity': 101300.0}, {'dt': datetime.datetime(2017, 11, 30, 14, 0), 'equity': 100590.0}, {'dt': datetime.datetime(2017, 12, 4, 10, 0), 'equity': 100670.0}, {'dt': datetime.datetime(2017, 12, 12, 14, 0), 'equity': 100740.0}, {'dt': datetime.datetime(2017, 12, 18, 14, 0), 'equity': 100530.0}, {'dt': datetime.datetime(2017, 12, 21, 10, 0), 'equity': 100870.0}, {'dt': datetime.datetime(2018, 1, 5, 6, 0), 'equity': 104100.0}, {'dt': datetime.datetime(2018, 1, 5, 14, 0), 'equity': 103940.0}, {'dt': datetime.datetime(2018, 1, 8, 10, 0), 'equity': 103670.0}, {'dt': datetime.datetime(2018, 1, 12, 2, 0), 'equity': 105170.0}, {'dt': datetime.datetime(2018, 1, 16, 6, 0), 'equity': 105050.0}, {'dt': datetime.datetime(2018, 1, 18, 2, 0), 'equity': 104960.0}, {'dt': datetime.datetime(2018, 1, 18, 18, 0), 'equity': 104740.0}, {'dt': datetime.datetime(2018, 1, 29, 10, 0), 'equity': 106420.0}, {'dt': datetime.datetime(2018, 2, 2, 10, 0), 'equity': 106310.0}, {'dt': datetime.datetime(2018, 2, 4, 18, 0), 'equity': 105790.0}, {'dt': datetime.datetime(2018, 2, 20, 10, 0), 'equity': 107450.0}, {'dt': datetime.datetime(2018, 2, 20, 18, 0), 'equity': 107080.0}, {'dt': datetime.datetime(2018, 2, 27, 14, 0), 'equity': 108180.0}, {'dt': datetime.datetime(2018, 3, 7, 2, 0), 'equity': 108710.0}, {'dt': datetime.datetime(2018, 3, 7, 10, 0), 'equity': 108540.0}, {'dt': datetime.datetime(2018, 3, 13, 14, 0), 'equity': 107890.0}, {'dt': datetime.datetime(2018, 3, 22, 18, 0), 'equity': 111040.0}, {'dt': datetime.datetime(2018, 3, 27, 10, 0), 'equity': 111420.0}, {'dt': datetime.datetime(2018, 4, 2, 10, 0), 'equity': 110370.0}, {'dt': datetime.datetime(2018, 4, 5, 22, 0), 'equity': 109890.0}, {'dt': datetime.datetime(2018, 4, 6, 14, 0), 'equity': 108170.0}, {'dt': datetime.datetime(2018, 4, 15, 22, 0), 'equity': 111990.0}, {'dt': datetime.datetime(2018, 4, 20, 10, 0), 'equity': 112980.0}, {'dt': datetime.datetime(2018, 4, 24, 14, 0), 'equity': 112410.0}, {'dt': datetime.datetime(2018, 4, 26, 14, 0), 'equity': 112070.0}, {'dt': datetime.datetime(2018, 4, 26, 22, 0), 'equity': 111800.0}, {'dt': datetime.datetime(2018, 4, 29, 18, 0), 'equity': 111779.99999999999}, {'dt': datetime.datetime(2018, 5, 1, 6, 0), 'equity': 110859.99999999999}]}\n",
      "{'params': 20, 'profit': 6929.999999999985, 'ntrade': 110, 'equity': [{'dt': datetime.datetime(2017, 1, 9, 6, 0), 'equity': 99520.0}, {'dt': datetime.datetime(2017, 1, 16, 10, 0), 'equity': 99240.0}, {'dt': datetime.datetime(2017, 1, 16, 22, 0), 'equity': 99220.0}, {'dt': datetime.datetime(2017, 1, 17, 18, 0), 'equity': 97870.0}, {'dt': datetime.datetime(2017, 1, 23, 6, 0), 'equity': 96980.0}, {'dt': datetime.datetime(2017, 1, 25, 6, 0), 'equity': 96660.0}, {'dt': datetime.datetime(2017, 1, 26, 6, 0), 'equity': 96330.0}, {'dt': datetime.datetime(2017, 1, 27, 10, 0), 'equity': 95630.0}, {'dt': datetime.datetime(2017, 1, 30, 10, 0), 'equity': 95020.0}, {'dt': datetime.datetime(2017, 1, 31, 14, 0), 'equity': 94810.0}, {'dt': datetime.datetime(2017, 2, 6, 14, 0), 'equity': 94910.0}, {'dt': datetime.datetime(2017, 2, 13, 14, 0), 'equity': 94860.0}, {'dt': datetime.datetime(2017, 2, 14, 14, 0), 'equity': 94840.0}, {'dt': datetime.datetime(2017, 2, 17, 6, 0), 'equity': 94740.0}, {'dt': datetime.datetime(2017, 2, 22, 6, 0), 'equity': 95180.0}, {'dt': datetime.datetime(2017, 2, 23, 2, 0), 'equity': 95160.0}, {'dt': datetime.datetime(2017, 2, 24, 6, 0), 'equity': 94970.0}, {'dt': datetime.datetime(2017, 2, 27, 18, 0), 'equity': 94710.0}, {'dt': datetime.datetime(2017, 3, 1, 2, 0), 'equity': 94570.0}, {'dt': datetime.datetime(2017, 3, 1, 14, 0), 'equity': 94310.0}, {'dt': datetime.datetime(2017, 3, 7, 18, 0), 'equity': 93860.0}, {'dt': datetime.datetime(2017, 3, 19, 22, 0), 'equity': 93780.0}, {'dt': datetime.datetime(2017, 3, 21, 10, 0), 'equity': 93420.0}, {'dt': datetime.datetime(2017, 3, 26, 22, 0), 'equity': 93150.0}, {'dt': datetime.datetime(2017, 4, 4, 2, 0), 'equity': 95200.0}, {'dt': datetime.datetime(2017, 4, 12, 18, 0), 'equity': 97440.0}, {'dt': datetime.datetime(2017, 4, 13, 14, 0), 'equity': 97280.0}, {'dt': datetime.datetime(2017, 4, 26, 18, 0), 'equity': 96720.0}, {'dt': datetime.datetime(2017, 4, 28, 6, 0), 'equity': 96650.0}, {'dt': datetime.datetime(2017, 4, 28, 14, 0), 'equity': 96440.0}, {'dt': datetime.datetime(2017, 5, 8, 6, 0), 'equity': 95840.0}, {'dt': datetime.datetime(2017, 5, 9, 10, 0), 'equity': 95340.0}, {'dt': datetime.datetime(2017, 5, 10, 2, 0), 'equity': 95250.0}, {'dt': datetime.datetime(2017, 5, 16, 18, 0), 'equity': 97150.0}, {'dt': datetime.datetime(2017, 5, 18, 6, 0), 'equity': 96880.0}, {'dt': datetime.datetime(2017, 5, 25, 6, 0), 'equity': 98190.0}, {'dt': datetime.datetime(2017, 5, 31, 2, 0), 'equity': 97880.0}, {'dt': datetime.datetime(2017, 6, 7, 14, 0), 'equity': 95900.0}, {'dt': datetime.datetime(2017, 6, 13, 10, 0), 'equity': 95410.0}, {'dt': datetime.datetime(2017, 6, 13, 18, 0), 'equity': 95060.0}, {'dt': datetime.datetime(2017, 6, 14, 14, 0), 'equity': 93690.0}, {'dt': datetime.datetime(2017, 6, 19, 14, 0), 'equity': 93220.0}, {'dt': datetime.datetime(2017, 7, 5, 6, 0), 'equity': 96550.0}, {'dt': datetime.datetime(2017, 7, 17, 18, 0), 'equity': 97430.0}, {'dt': datetime.datetime(2017, 7, 18, 2, 0), 'equity': 97280.0}, {'dt': datetime.datetime(2017, 7, 18, 14, 0), 'equity': 97330.0}, {'dt': datetime.datetime(2017, 7, 21, 10, 0), 'equity': 97120.0}, {'dt': datetime.datetime(2017, 8, 1, 14, 0), 'equity': 99420.0}, {'dt': datetime.datetime(2017, 8, 2, 22, 0), 'equity': 99270.0}, {'dt': datetime.datetime(2017, 8, 3, 14, 0), 'equity': 98770.0}, {'dt': datetime.datetime(2017, 8, 7, 6, 0), 'equity': 98260.0}, {'dt': datetime.datetime(2017, 8, 8, 10, 0), 'equity': 98050.0}, {'dt': datetime.datetime(2017, 8, 10, 14, 0), 'equity': 97430.0}, {'dt': datetime.datetime(2017, 8, 14, 14, 0), 'equity': 96310.0}, {'dt': datetime.datetime(2017, 8, 18, 10, 0), 'equity': 96000.0}, {'dt': datetime.datetime(2017, 8, 21, 14, 0), 'equity': 94800.0}, {'dt': datetime.datetime(2017, 8, 22, 14, 0), 'equity': 94900.0}, {'dt': datetime.datetime(2017, 8, 24, 10, 0), 'equity': 94350.0}, {'dt': datetime.datetime(2017, 9, 8, 14, 0), 'equity': 95190.0}, {'dt': datetime.datetime(2017, 9, 19, 2, 0), 'equity': 96560.0}, {'dt': datetime.datetime(2017, 9, 19, 14, 0), 'equity': 95660.0}, {'dt': datetime.datetime(2017, 9, 21, 10, 0), 'equity': 95450.0}, {'dt': datetime.datetime(2017, 9, 25, 2, 0), 'equity': 95380.0}, {'dt': datetime.datetime(2017, 9, 28, 14, 0), 'equity': 96300.0}, {'dt': datetime.datetime(2017, 10, 6, 10, 0), 'equity': 95310.0}, {'dt': datetime.datetime(2017, 10, 12, 10, 0), 'equity': 95640.0}, {'dt': datetime.datetime(2017, 10, 19, 6, 0), 'equity': 96260.0}, {'dt': datetime.datetime(2017, 10, 23, 6, 0), 'equity': 96020.0}, {'dt': datetime.datetime(2017, 10, 25, 14, 0), 'equity': 95910.0}, {'dt': datetime.datetime(2017, 10, 25, 22, 0), 'equity': 95810.0}, {'dt': datetime.datetime(2017, 10, 26, 10, 0), 'equity': 95680.0}, {'dt': datetime.datetime(2017, 11, 1, 14, 0), 'equity': 97140.0}, {'dt': datetime.datetime(2017, 11, 2, 2, 0), 'equity': 97120.0}, {'dt': datetime.datetime(2017, 11, 2, 10, 0), 'equity': 97070.0}, {'dt': datetime.datetime(2017, 11, 9, 6, 0), 'equity': 99530.0}, {'dt': datetime.datetime(2017, 11, 9, 18, 0), 'equity': 99320.0}, {'dt': datetime.datetime(2017, 11, 10, 14, 0), 'equity': 99140.0}, {'dt': datetime.datetime(2017, 11, 27, 10, 0), 'equity': 101090.0}, {'dt': datetime.datetime(2017, 11, 30, 10, 0), 'equity': 100930.0}, {'dt': datetime.datetime(2017, 12, 4, 10, 0), 'equity': 100850.0}, {'dt': datetime.datetime(2017, 12, 12, 14, 0), 'equity': 100920.0}, {'dt': datetime.datetime(2017, 12, 13, 10, 0), 'equity': 100660.0}, {'dt': datetime.datetime(2017, 12, 18, 14, 0), 'equity': 100290.0}, {'dt': datetime.datetime(2018, 1, 8, 10, 0), 'equity': 104440.0}, {'dt': datetime.datetime(2018, 1, 16, 6, 0), 'equity': 106510.0}, {'dt': datetime.datetime(2018, 1, 16, 14, 0), 'equity': 106260.0}, {'dt': datetime.datetime(2018, 1, 18, 2, 0), 'equity': 105990.0}, {'dt': datetime.datetime(2018, 1, 29, 10, 0), 'equity': 107670.0}, {'dt': datetime.datetime(2018, 2, 2, 10, 0), 'equity': 107030.0}, {'dt': datetime.datetime(2018, 2, 4, 22, 0), 'equity': 106130.0}, {'dt': datetime.datetime(2018, 2, 5, 10, 0), 'equity': 105520.0}, {'dt': datetime.datetime(2018, 2, 20, 18, 0), 'equity': 107170.0}, {'dt': datetime.datetime(2018, 2, 27, 14, 0), 'equity': 108270.0}, {'dt': datetime.datetime(2018, 3, 5, 10, 0), 'equity': 108040.0}, {'dt': datetime.datetime(2018, 3, 7, 14, 0), 'equity': 106690.0}, {'dt': datetime.datetime(2018, 3, 12, 14, 0), 'equity': 106020.0}, {'dt': datetime.datetime(2018, 3, 13, 14, 0), 'equity': 105110.0}, {'dt': datetime.datetime(2018, 3, 27, 14, 0), 'equity': 108830.0}, {'dt': datetime.datetime(2018, 4, 1, 18, 0), 'equity': 108540.0}, {'dt': datetime.datetime(2018, 4, 2, 10, 0), 'equity': 107490.0}, {'dt': datetime.datetime(2018, 4, 5, 6, 0), 'equity': 107260.0}, {'dt': datetime.datetime(2018, 4, 5, 22, 0), 'equity': 106480.0}, {'dt': datetime.datetime(2018, 4, 6, 14, 0), 'equity': 104760.0}, {'dt': datetime.datetime(2018, 4, 16, 6, 0), 'equity': 108280.0}, {'dt': datetime.datetime(2018, 4, 20, 10, 0), 'equity': 109149.99999999999}, {'dt': datetime.datetime(2018, 4, 23, 6, 0), 'equity': 108780.0}, {'dt': datetime.datetime(2018, 4, 24, 14, 0), 'equity': 108210.0}, {'dt': datetime.datetime(2018, 4, 26, 14, 0), 'equity': 107870.0}, {'dt': datetime.datetime(2018, 4, 29, 18, 0), 'equity': 107849.99999999999}, {'dt': datetime.datetime(2018, 5, 1, 6, 0), 'equity': 106929.99999999999}]}\n",
      "{'params': 25, 'profit': 8470.0, 'ntrade': 88, 'equity': [{'dt': datetime.datetime(2017, 1, 9, 6, 0), 'equity': 99380.0}, {'dt': datetime.datetime(2017, 1, 17, 2, 0), 'equity': 99040.0}, {'dt': datetime.datetime(2017, 1, 17, 18, 0), 'equity': 97690.0}, {'dt': datetime.datetime(2017, 1, 23, 6, 0), 'equity': 96800.0}, {'dt': datetime.datetime(2017, 1, 25, 6, 0), 'equity': 96480.0}, {'dt': datetime.datetime(2017, 1, 26, 6, 0), 'equity': 96380.0}, {'dt': datetime.datetime(2017, 1, 27, 10, 0), 'equity': 95680.0}, {'dt': datetime.datetime(2017, 1, 29, 22, 0), 'equity': 95540.0}, {'dt': datetime.datetime(2017, 1, 30, 10, 0), 'equity': 94930.0}, {'dt': datetime.datetime(2017, 1, 31, 14, 0), 'equity': 94720.0}, {'dt': datetime.datetime(2017, 2, 6, 14, 0), 'equity': 94600.0}, {'dt': datetime.datetime(2017, 2, 13, 18, 0), 'equity': 94610.0}, {'dt': datetime.datetime(2017, 2, 14, 2, 0), 'equity': 94440.0}, {'dt': datetime.datetime(2017, 2, 14, 18, 0), 'equity': 94110.0}, {'dt': datetime.datetime(2017, 2, 17, 6, 0), 'equity': 93750.0}, {'dt': datetime.datetime(2017, 2, 22, 10, 0), 'equity': 93720.0}, {'dt': datetime.datetime(2017, 2, 24, 6, 0), 'equity': 93760.0}, {'dt': datetime.datetime(2017, 2, 27, 14, 0), 'equity': 93630.0}, {'dt': datetime.datetime(2017, 3, 1, 14, 0), 'equity': 93370.0}, {'dt': datetime.datetime(2017, 3, 7, 14, 0), 'equity': 93200.0}, {'dt': datetime.datetime(2017, 3, 19, 22, 0), 'equity': 92660.0}, {'dt': datetime.datetime(2017, 3, 21, 10, 0), 'equity': 92300.0}, {'dt': datetime.datetime(2017, 4, 13, 14, 0), 'equity': 97330.0}, {'dt': datetime.datetime(2017, 4, 26, 18, 0), 'equity': 96770.0}, {'dt': datetime.datetime(2017, 4, 28, 6, 0), 'equity': 96550.0}, {'dt': datetime.datetime(2017, 4, 28, 14, 0), 'equity': 96340.0}, {'dt': datetime.datetime(2017, 5, 16, 18, 0), 'equity': 98240.0}, {'dt': datetime.datetime(2017, 5, 18, 6, 0), 'equity': 97970.0}, {'dt': datetime.datetime(2017, 5, 25, 6, 0), 'equity': 99850.0}, {'dt': datetime.datetime(2017, 6, 7, 10, 0), 'equity': 99650.0}, {'dt': datetime.datetime(2017, 6, 13, 10, 0), 'equity': 99240.0}, {'dt': datetime.datetime(2017, 6, 13, 18, 0), 'equity': 98890.0}, {'dt': datetime.datetime(2017, 6, 14, 14, 0), 'equity': 97520.0}, {'dt': datetime.datetime(2017, 7, 5, 10, 0), 'equity': 100120.0}, {'dt': datetime.datetime(2017, 7, 17, 18, 0), 'equity': 101000.0}, {'dt': datetime.datetime(2017, 7, 18, 2, 0), 'equity': 100850.0}, {'dt': datetime.datetime(2017, 7, 21, 10, 0), 'equity': 100960.0}, {'dt': datetime.datetime(2017, 8, 1, 14, 0), 'equity': 103060.0}, {'dt': datetime.datetime(2017, 8, 2, 22, 0), 'equity': 102910.0}, {'dt': datetime.datetime(2017, 8, 3, 14, 0), 'equity': 102410.0}, {'dt': datetime.datetime(2017, 8, 7, 6, 0), 'equity': 101610.0}, {'dt': datetime.datetime(2017, 8, 8, 10, 0), 'equity': 101510.0}, {'dt': datetime.datetime(2017, 8, 10, 14, 0), 'equity': 100890.0}, {'dt': datetime.datetime(2017, 8, 14, 14, 0), 'equity': 99770.0}, {'dt': datetime.datetime(2017, 8, 21, 14, 0), 'equity': 98570.0}, {'dt': datetime.datetime(2017, 8, 22, 18, 0), 'equity': 98520.0}, {'dt': datetime.datetime(2017, 8, 24, 10, 0), 'equity': 97970.0}, {'dt': datetime.datetime(2017, 8, 27, 22, 0), 'equity': 97780.0}, {'dt': datetime.datetime(2017, 9, 8, 14, 0), 'equity': 97840.0}, {'dt': datetime.datetime(2017, 9, 19, 14, 0), 'equity': 98430.0}, {'dt': datetime.datetime(2017, 9, 21, 10, 0), 'equity': 98220.0}, {'dt': datetime.datetime(2017, 9, 25, 2, 0), 'equity': 98150.0}, {'dt': datetime.datetime(2017, 9, 28, 14, 0), 'equity': 99070.0}, {'dt': datetime.datetime(2017, 10, 6, 10, 0), 'equity': 97880.0}, {'dt': datetime.datetime(2017, 10, 19, 6, 0), 'equity': 99270.0}, {'dt': datetime.datetime(2017, 10, 23, 6, 0), 'equity': 99030.0}, {'dt': datetime.datetime(2017, 10, 23, 18, 0), 'equity': 98760.0}, {'dt': datetime.datetime(2017, 11, 10, 14, 0), 'equity': 103630.0}, {'dt': datetime.datetime(2017, 11, 27, 18, 0), 'equity': 105370.0}, {'dt': datetime.datetime(2017, 12, 4, 10, 0), 'equity': 105290.0}, {'dt': datetime.datetime(2017, 12, 5, 18, 0), 'equity': 105060.0}, {'dt': datetime.datetime(2017, 12, 13, 10, 0), 'equity': 105170.0}, {'dt': datetime.datetime(2017, 12, 18, 14, 0), 'equity': 104750.0}, {'dt': datetime.datetime(2018, 1, 16, 14, 0), 'equity': 111270.0}, {'dt': datetime.datetime(2018, 1, 18, 2, 0), 'equity': 111180.0}, {'dt': datetime.datetime(2018, 1, 29, 14, 0), 'equity': 112780.0}, {'dt': datetime.datetime(2018, 2, 2, 10, 0), 'equity': 112140.0}, {'dt': datetime.datetime(2018, 2, 4, 22, 0), 'equity': 111240.0}, {'dt': datetime.datetime(2018, 2, 5, 10, 0), 'equity': 110630.0}, {'dt': datetime.datetime(2018, 2, 20, 22, 0), 'equity': 111990.0}, {'dt': datetime.datetime(2018, 2, 27, 18, 0), 'equity': 112900.0}, {'dt': datetime.datetime(2018, 2, 28, 14, 0), 'equity': 112010.0}, {'dt': datetime.datetime(2018, 3, 7, 14, 0), 'equity': 110660.0}, {'dt': datetime.datetime(2018, 3, 12, 14, 0), 'equity': 109990.0}, {'dt': datetime.datetime(2018, 3, 13, 14, 0), 'equity': 109120.0}, {'dt': datetime.datetime(2018, 3, 15, 18, 0), 'equity': 108790.0}, {'dt': datetime.datetime(2018, 3, 16, 10, 0), 'equity': 108670.0}, {'dt': datetime.datetime(2018, 3, 27, 18, 0), 'equity': 111030.0}, {'dt': datetime.datetime(2018, 4, 1, 18, 0), 'equity': 110740.0}, {'dt': datetime.datetime(2018, 4, 2, 10, 0), 'equity': 109690.0}, {'dt': datetime.datetime(2018, 4, 5, 14, 0), 'equity': 109220.0}, {'dt': datetime.datetime(2018, 4, 5, 22, 0), 'equity': 108640.0}, {'dt': datetime.datetime(2018, 4, 6, 14, 0), 'equity': 106920.0}, {'dt': datetime.datetime(2018, 4, 16, 14, 0), 'equity': 109860.0}, {'dt': datetime.datetime(2018, 4, 23, 10, 0), 'equity': 110300.0}, {'dt': datetime.datetime(2018, 4, 24, 14, 0), 'equity': 109730.0}, {'dt': datetime.datetime(2018, 4, 26, 14, 0), 'equity': 109390.0}, {'dt': datetime.datetime(2018, 5, 1, 6, 0), 'equity': 108470.0}]}\n",
      "{'params': 30, 'profit': 10389.999999999985, 'ntrade': 84, 'equity': [{'dt': datetime.datetime(2017, 1, 13, 6, 0), 'equity': 99750.0}, {'dt': datetime.datetime(2017, 1, 18, 6, 0), 'equity': 98660.0}, {'dt': datetime.datetime(2017, 1, 23, 6, 0), 'equity': 97770.0}, {'dt': datetime.datetime(2017, 1, 23, 18, 0), 'equity': 97710.0}, {'dt': datetime.datetime(2017, 1, 25, 6, 0), 'equity': 97340.0}, {'dt': datetime.datetime(2017, 1, 27, 10, 0), 'equity': 97440.0}, {'dt': datetime.datetime(2017, 1, 29, 22, 0), 'equity': 97300.0}, {'dt': datetime.datetime(2017, 1, 30, 10, 0), 'equity': 96690.0}, {'dt': datetime.datetime(2017, 1, 31, 14, 0), 'equity': 96480.0}, {'dt': datetime.datetime(2017, 2, 6, 14, 0), 'equity': 96360.0}, {'dt': datetime.datetime(2017, 2, 14, 22, 0), 'equity': 96200.0}, {'dt': datetime.datetime(2017, 2, 15, 14, 0), 'equity': 96200.0}, {'dt': datetime.datetime(2017, 2, 17, 6, 0), 'equity': 95840.0}, {'dt': datetime.datetime(2017, 2, 22, 10, 0), 'equity': 95480.0}, {'dt': datetime.datetime(2017, 2, 24, 10, 0), 'equity': 95400.0}, {'dt': datetime.datetime(2017, 2, 27, 14, 0), 'equity': 95270.0}, {'dt': datetime.datetime(2017, 3, 1, 2, 0), 'equity': 95130.0}, {'dt': datetime.datetime(2017, 3, 1, 14, 0), 'equity': 94870.0}, {'dt': datetime.datetime(2017, 3, 7, 14, 0), 'equity': 94460.0}, {'dt': datetime.datetime(2017, 3, 19, 22, 0), 'equity': 93920.0}, {'dt': datetime.datetime(2017, 3, 21, 2, 0), 'equity': 93890.0}, {'dt': datetime.datetime(2017, 3, 21, 10, 0), 'equity': 93530.0}, {'dt': datetime.datetime(2017, 4, 16, 22, 0), 'equity': 98320.0}, {'dt': datetime.datetime(2017, 4, 17, 14, 0), 'equity': 97970.0}, {'dt': datetime.datetime(2017, 4, 28, 6, 0), 'equity': 97750.0}, {'dt': datetime.datetime(2017, 4, 28, 14, 0), 'equity': 97540.0}, {'dt': datetime.datetime(2017, 5, 18, 6, 0), 'equity': 99220.0}, {'dt': datetime.datetime(2017, 5, 25, 14, 0), 'equity': 99190.0}, {'dt': datetime.datetime(2017, 6, 7, 10, 0), 'equity': 98850.0}, {'dt': datetime.datetime(2017, 6, 14, 14, 0), 'equity': 97480.0}, {'dt': datetime.datetime(2017, 6, 26, 10, 0), 'equity': 97130.0}, {'dt': datetime.datetime(2017, 7, 5, 14, 0), 'equity': 99060.0}, {'dt': datetime.datetime(2017, 7, 21, 10, 0), 'equity': 99610.0}, {'dt': datetime.datetime(2017, 8, 1, 14, 0), 'equity': 101710.0}, {'dt': datetime.datetime(2017, 8, 3, 14, 0), 'equity': 101580.0}, {'dt': datetime.datetime(2017, 8, 7, 6, 0), 'equity': 100780.0}, {'dt': datetime.datetime(2017, 8, 7, 22, 0), 'equity': 100730.0}, {'dt': datetime.datetime(2017, 8, 8, 10, 0), 'equity': 100580.0}, {'dt': datetime.datetime(2017, 8, 10, 14, 0), 'equity': 99960.0}, {'dt': datetime.datetime(2017, 8, 21, 14, 0), 'equity': 98760.0}, {'dt': datetime.datetime(2017, 8, 22, 18, 0), 'equity': 98710.0}, {'dt': datetime.datetime(2017, 8, 24, 14, 0), 'equity': 98450.0}, {'dt': datetime.datetime(2017, 9, 1, 6, 0), 'equity': 97760.0}, {'dt': datetime.datetime(2017, 9, 8, 14, 0), 'equity': 98360.0}, {'dt': datetime.datetime(2017, 9, 19, 14, 0), 'equity': 98950.0}, {'dt': datetime.datetime(2017, 9, 20, 2, 0), 'equity': 98880.0}, {'dt': datetime.datetime(2017, 9, 21, 10, 0), 'equity': 98670.0}, {'dt': datetime.datetime(2017, 9, 28, 14, 0), 'equity': 99590.0}, {'dt': datetime.datetime(2017, 9, 29, 2, 0), 'equity': 99460.0}, {'dt': datetime.datetime(2017, 10, 6, 6, 0), 'equity': 99220.0}, {'dt': datetime.datetime(2017, 10, 12, 10, 0), 'equity': 98900.0}, {'dt': datetime.datetime(2017, 10, 19, 6, 0), 'equity': 99700.0}, {'dt': datetime.datetime(2017, 10, 23, 6, 0), 'equity': 99460.0}, {'dt': datetime.datetime(2017, 10, 23, 14, 0), 'equity': 99220.0}, {'dt': datetime.datetime(2017, 11, 12, 22, 0), 'equity': 104040.0}, {'dt': datetime.datetime(2017, 11, 27, 22, 0), 'equity': 105670.0}, {'dt': datetime.datetime(2017, 12, 4, 10, 0), 'equity': 104730.0}, {'dt': datetime.datetime(2017, 12, 5, 18, 0), 'equity': 104500.0}, {'dt': datetime.datetime(2017, 12, 13, 14, 0), 'equity': 104160.0}, {'dt': datetime.datetime(2017, 12, 18, 10, 0), 'equity': 104160.0}, {'dt': datetime.datetime(2018, 1, 16, 14, 0), 'equity': 110680.0}, {'dt': datetime.datetime(2018, 1, 18, 2, 0), 'equity': 110590.0}, {'dt': datetime.datetime(2018, 1, 29, 22, 0), 'equity': 111960.0}, {'dt': datetime.datetime(2018, 2, 2, 10, 0), 'equity': 111320.0}, {'dt': datetime.datetime(2018, 2, 4, 18, 0), 'equity': 110800.0}, {'dt': datetime.datetime(2018, 2, 5, 10, 0), 'equity': 110190.0}, {'dt': datetime.datetime(2018, 2, 21, 18, 0), 'equity': 111550.0}, {'dt': datetime.datetime(2018, 2, 27, 22, 0), 'equity': 112310.0}, {'dt': datetime.datetime(2018, 2, 28, 14, 0), 'equity': 111770.0}, {'dt': datetime.datetime(2018, 3, 7, 14, 0), 'equity': 110420.0}, {'dt': datetime.datetime(2018, 3, 12, 10, 0), 'equity': 110120.0}, {'dt': datetime.datetime(2018, 3, 13, 14, 0), 'equity': 109030.0}, {'dt': datetime.datetime(2018, 3, 15, 18, 0), 'equity': 108700.0}, {'dt': datetime.datetime(2018, 3, 16, 10, 0), 'equity': 108460.0}, {'dt': datetime.datetime(2018, 3, 27, 18, 0), 'equity': 110820.0}, {'dt': datetime.datetime(2018, 4, 1, 18, 0), 'equity': 110530.0}, {'dt': datetime.datetime(2018, 4, 2, 10, 0), 'equity': 109480.0}, {'dt': datetime.datetime(2018, 4, 5, 14, 0), 'equity': 109010.0}, {'dt': datetime.datetime(2018, 4, 17, 6, 0), 'equity': 111680.0}, {'dt': datetime.datetime(2018, 4, 23, 10, 0), 'equity': 112240.0}, {'dt': datetime.datetime(2018, 4, 24, 14, 0), 'equity': 111670.0}, {'dt': datetime.datetime(2018, 4, 26, 14, 0), 'equity': 111330.0}, {'dt': datetime.datetime(2018, 4, 29, 18, 0), 'equity': 111309.99999999999}, {'dt': datetime.datetime(2018, 5, 1, 6, 0), 'equity': 110389.99999999999}]}\n"
     ]
    }
   ],
   "source": [
    "start_date = periods[0]['is'][0]\n",
    "end_date = periods[-1]['is'][1]\n",
    "print('Start/End: {} - {}'.format(start_date, end_date))\n",
    "\n",
    "cerebro = bt.Cerebro()\n",
    "\n",
    "strats = cerebro.optstrategy(\n",
    "    TestStrategy,\n",
    "    maperiod=range(10, 31, 5))\n",
    "\n",
    "cerebro.addanalyzer(DecisiveAnalyzer, _name='decisive')\n",
    "\n",
    "cerebro.optreturn = False\n",
    "cerebro.broker.setcash(100000.0)\n",
    "cerebro.addsizer(bt.sizers.FixedSize, stake=1000)\n",
    "cerebro.broker.setcommission(commission=0.0)\n",
    "\n",
    "data = bt.feeds.PandasData(dataname = df[start_date:end_date])\n",
    "cerebro.adddata(data)\n",
    "\n",
    "results = cerebro.run(maxcpus=1)\n",
    "for result in results:\n",
    "    r = result[0].analyzers.decisive.get_analysis()\n",
    "    print(r)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "best_oos_params = []\n",
    "for oos_is in periods:\n",
    "    start_date, end_date = oos_is['is']\n",
    "    run_num = oos_is['run']\n",
    "    print('RUN {} \\t START/END: {}/{}'.format(run_num, start_date, end_date))\n",
    "    cerebro = bt.Cerebro()\n",
    "\n",
    "    strats = cerebro.optstrategy(\n",
    "        TestStrategy,\n",
    "        maperiod=range(10, 31, 5))\n",
    "    \n",
    "    cerebro.addanalyzer(DecisiveAnalyzer, _name='decisive')\n",
    "\n",
    "    cerebro.optreturn = False\n",
    "    cerebro.broker.setcash(100000.0)\n",
    "    cerebro.addsizer(bt.sizers.FixedSize, stake=1000)\n",
    "    cerebro.broker.setcommission(commission=0.0)\n",
    "\n",
    "    data = bt.feeds.PandasData(dataname = df[start_date:end_date])\n",
    "    cerebro.adddata(data)\n",
    "\n",
    "    result = cerebro.run(maxcpus=1)\n",
    "    best_param, best_profit, best_trades, best_equity = best_result_from_cerebro_opti_run(result)\n",
    "\n",
    "    best_oos_params.append({'train_param': best_param, \n",
    "                                      'train_profit': best_profit, \n",
    "                                      'train_numtrades': best_trades, \n",
    "                                      'train_tradeslist': best_equity, \n",
    "                                      'train_period': oos_is['is'],\n",
    "                                      'test_period': oos_is['oos'],\n",
    "                                     })\n",
    "    \n",
    "    print('')\n",
    "\n",
    "print('The best OOS parameters are: {}'.format(pformat(best_oos_params)))\n",
    "print('Note: Must account for pre-allocation of bars for the period for a correct WFE calculation.  This current implementation is incorrect.')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "trades_list = np.asarray(best_oos_params[1]['train_tradeslist'])\n",
    "cumsum = trades_list.cumsum()\n",
    "plt.plot(cumsum)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Out-of-sample Parameters"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "run_num = 0\n",
    "for best in best_oos_params:\n",
    "    start_date, end_date = best['test_period']\n",
    "    print('RUN {} \\t START/END: {}/{}'.format(run_num, start_date, end_date))\n",
    "    cerebro = bt.Cerebro()\n",
    "\n",
    "    cerebro.addstrategy(TestStrategy, maperiod=best['train_param'])\n",
    "\n",
    "    \n",
    "    cerebro.addanalyzer(DecisiveAnalyzer, _name='decisive')\n",
    "\n",
    "    cerebro.broker.setcash(100000.0)\n",
    "    cerebro.addsizer(bt.sizers.FixedSize, stake=1000)\n",
    "    cerebro.broker.setcommission(commission=0.0)\n",
    "\n",
    "    data = bt.feeds.PandasData(dataname = df[start_date:end_date])\n",
    "    cerebro.adddata(data)\n",
    "\n",
    "    result = cerebro.run(maxcpus=1)\n",
    "    r = result[0].analyzers.decisive.get_analysis()\n",
    "    best_oos_params[run_num]['test_numtrades'] = r['ntrade']\n",
    "    best_oos_params[run_num]['test_tradeslist'] = r['trades']\n",
    "    best_oos_params[run_num]['test_profit'] = r['profit']\n",
    "    run_num += 1\n",
    "\n",
    "    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "print('The best OOS parameters are: {}'.format(pformat(best_oos_params)))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Walkforward"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create a Stratey\n",
    "class WalkforwardStrategy(bt.Strategy):\n",
    "\n",
    "    params = (\n",
    "        ('maperiod', 15),\n",
    "        ('printlog', False),\n",
    "        ('live', False),\n",
    "        ('walkforward', None),\n",
    "    )\n",
    "\n",
    "    def log(self, txt, dt=None, doprint=False):\n",
    "        ''' Logging function fot this strategy'''\n",
    "        if self.params.printlog or doprint:\n",
    "            dt = dt or self.datas[0].datetime.date(0)\n",
    "            print('%s, %s' % (dt.isoformat(), txt))\n",
    "\n",
    "    def __init__(self):\n",
    "        # Keep a reference to the \"close\" line in the data[0] dataseries\n",
    "        self.dataclose = self.datas[0].close\n",
    "\n",
    "        # To keep track of pending orders and buy price/commission\n",
    "        self.order = None\n",
    "        self.buyprice = None\n",
    "        self.buycomm = None\n",
    "\n",
    "        # Add a MovingAverageSimple indicator\n",
    "        self.sma = bt.indicators.SimpleMovingAverage(\n",
    "            self.datas[0], period=self.params.maperiod)\n",
    "        \n",
    "        # Trim the indicators if we are running live, just need the current one\n",
    "        if not self.params.live:\n",
    "            pass\n",
    "        \n",
    "        \n",
    "        self.current_row = None\n",
    "        self.wfsma = []\n",
    "        \n",
    "        if self.params.walkforward:\n",
    "            for run in self.params.walkforward:\n",
    "                self.wfsma.append({\n",
    "                    'sma': bt.indicators.SimpleMovingAverage(self.datas[0], period=run['train_param']),\n",
    "                    'test_period': run['test_period'],\n",
    "                    'train_param': run['train_param'],\n",
    "                }) \n",
    "\n",
    "        print(pformat(self.wfsma))\n",
    "        \n",
    "        \n",
    "\n",
    "    def notify_order(self, order):\n",
    "        if order.status in [order.Submitted, order.Accepted]:\n",
    "            # Buy/Sell order submitted/accepted to/by broker - Nothing to do\n",
    "            return\n",
    "\n",
    "        # Check if an order has been completed\n",
    "        # Attention: broker could reject order if not enough cash\n",
    "        if order.status in [order.Completed]:\n",
    "            if order.isbuy():\n",
    "                self.log(\n",
    "                    'BUY EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' %\n",
    "                    (order.executed.price,\n",
    "                     order.executed.value,\n",
    "                     order.executed.comm))\n",
    "\n",
    "                self.buyprice = order.executed.price\n",
    "                self.buycomm = order.executed.comm\n",
    "            else:  # Sell\n",
    "                self.log('SELL EXECUTED, Price: %.2f, Cost: %.2f, Comm %.2f' %\n",
    "                         (order.executed.price,\n",
    "                          order.executed.value,\n",
    "                          order.executed.comm))\n",
    "\n",
    "            self.bar_executed = len(self)\n",
    "\n",
    "        elif order.status in [order.Canceled, order.Margin, order.Rejected]:\n",
    "            self.log('Order Canceled/Margin/Rejected')\n",
    "\n",
    "        # Write down: no pending order\n",
    "        self.order = None\n",
    "\n",
    "    def notify_trade(self, trade):\n",
    "        if not trade.isclosed:\n",
    "            return\n",
    "\n",
    "        self.log('OPERATION PROFIT, GROSS %.2f, NET %.2f' %\n",
    "                 (trade.pnl, trade.pnlcomm))\n",
    "\n",
    "    def next(self):\n",
    "\n",
    "        # Walk-forward logic\n",
    "        for row in self.wfsma:\n",
    "            start, end = row['test_period']\n",
    "            period_start = datetime.datetime.strptime(start, '%Y-%m-%d')\n",
    "            period_end = datetime.datetime.strptime(end, '%Y-%m-%d')\n",
    "            if self.datetime.datetime() >= period_start and self.datetime.datetime() < period_end:\n",
    "                self.current_row = row\n",
    "        \n",
    "        # Simply log the closing price of the series from the reference\n",
    "        self.log('Close, %.2f' % self.dataclose[0])\n",
    "\n",
    "        # Check if an order is pending ... if yes, we cannot send a 2nd one\n",
    "        if self.order:\n",
    "            return\n",
    "\n",
    "        # Check if we are in the market\n",
    "        if not self.position:\n",
    "\n",
    "            # Not yet ... we MIGHT BUY if ...\n",
    "            if self.dataclose[0] > self.current_row['sma'][0]:\n",
    "\n",
    "                # BUY, BUY, BUY!!! (with all possible default parameters)\n",
    "                self.log('BUY CREATE, %.2f' % self.dataclose[0])\n",
    "\n",
    "                # Keep track of the created order to avoid a 2nd order\n",
    "                self.order = self.buy()\n",
    "\n",
    "        else:\n",
    "\n",
    "            if self.dataclose[0] < self.current_row['sma'][0]:\n",
    "                # SELL, SELL, SELL!!! (with all possible default parameters)\n",
    "                self.log('SELL CREATE, %.2f' % self.dataclose[0])\n",
    "\n",
    "                # Keep track of the created order to avoid a 2nd order\n",
    "                self.order = self.sell()\n",
    "\n",
    "    def stop(self):\n",
    "        self.log('maperiod:%2d, %.2f' %\n",
    "                 (self.params.maperiod, self.broker.getvalue()), doprint=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Create a cerebro entity\n",
    "cerebro = bt.Cerebro()\n",
    "\n",
    "# Add a strategy\n",
    "cerebro.addstrategy(WalkforwardStrategy, \n",
    "                    maperiod=15, \n",
    "                    walkforward=best_oos_params,\n",
    "                    live=False)\n",
    "\n",
    "# Load data\n",
    "fname_symbol = 'CL'\n",
    "folder_name = '5min'\n",
    "suffix = '5min_20160103_20190405'\n",
    "\n",
    "df = pd.read_parquet(os.path.join('../data/processed/{}/'.format(folder_name), '{}_{}.parquet'.format(fname_symbol, suffix)))\n",
    "df = (df.resample('4h', label='left', base=18).agg({'Open': 'first', 'High': 'max', 'Low': 'min', 'Close': 'last', 'Volume': 'sum'}))\n",
    "df.columns = [col_name.lower() for col_name in df.columns]\n",
    "df = df.dropna()\n",
    "\n",
    "# periods\n",
    "start_date = best_oos_params[0]['test_period'][0]\n",
    "end_date = best_oos_params[-1]['test_period'][0]\n",
    "\n",
    "print('Start: {} End: {}'.format(start_date, end_date))\n",
    "data = bt.feeds.PandasData(dataname = df[start_date:end_date])\n",
    "\n",
    "\n",
    "# Add the Data Feed to Cerebro\n",
    "cerebro.adddata(data)\n",
    "cerebro.addanalyzer(DecisiveAnalyzer, _name='decisive')\n",
    "\n",
    "# Set our desired cash start\n",
    "cerebro.broker.setcash(100000.0)\n",
    "cerebro.addsizer(bt.sizers.FixedSize, stake=1000)\n",
    "\n",
    "# Print out the starting conditions\n",
    "print('Starting Portfolio Value: %.2f' % cerebro.broker.getvalue())\n",
    "\n",
    "# Run over everything\n",
    "results = cerebro.run()\n",
    "\n",
    "# Print out the final result\n",
    "print('Final Portfolio Value: %.2f' % cerebro.broker.getvalue())\n",
    "r = results[0].analyzers.decisive.get_analysis()\n",
    "cumsum = np.asarray(r['trades']).cumsum()\n",
    "\n",
    "plt.figure(figsize=(10,5))\n",
    "plt.plot(cumsum)\n",
    "plt.title('Walkforward Equity Curve')\n",
    "plt.xlabel('Trades')\n",
    "plt.ylabel('Equity')\n",
    "\n",
    "# cerebro.plot(volume=False, iplot=False)\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.8"
  },
  "toc": {
   "base_numbering": 1,
   "nav_menu": {},
   "number_sections": true,
   "sideBar": true,
   "skip_h1_title": false,
   "title_cell": "Table of Contents",
   "title_sidebar": "Contents",
   "toc_cell": false,
   "toc_position": {},
   "toc_section_display": true,
   "toc_window_display": false
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
